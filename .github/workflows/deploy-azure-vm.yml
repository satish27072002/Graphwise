name: Deploy Azure VM

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "infra/docker-compose.yml"
      - "frontend/**"
      - "backend/services/**"
      - "backend/shared/**"
      - ".github/workflows/deploy-azure-vm.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AZURE_APP_DIR: /opt/graphwise
      AUTO_INSTALL_DOCKER: "false"
    steps:
      - uses: actions/checkout@v4

      - name: Check required deploy secrets
        id: precheck
        env:
          AZURE_VM_HOST: ${{ secrets.AZURE_VM_HOST }}
          AZURE_VM_USER: ${{ secrets.AZURE_VM_USER }}
          AZURE_VM_SSH_KEY: ${{ secrets.AZURE_VM_SSH_KEY }}
        run: |
          if [ -z "${AZURE_VM_HOST:-}" ] || [ -z "${AZURE_VM_USER:-}" ] || [ -z "${AZURE_VM_SSH_KEY:-}" ]; then
            echo "ready=false" >> "$GITHUB_OUTPUT"
            echo "Azure deploy secrets are not fully configured. Skipping deployment."
          else
            echo "ready=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Start SSH agent
        if: steps.precheck.outputs.ready == 'true'
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.AZURE_VM_SSH_KEY }}

      - name: Sync repository to VM
        if: steps.precheck.outputs.ready == 'true'
        env:
          VM_HOST: ${{ secrets.AZURE_VM_HOST }}
          VM_USER: ${{ secrets.AZURE_VM_USER }}
        run: |
          rsync -az --delete \
            --exclude '.env' \
            --exclude '.env.backup' \
            --exclude '.git' \
            --exclude 'frontend/node_modules' \
            --exclude 'frontend/.next' \
            --exclude 'frontend/dist' \
            --exclude 'data' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ "${VM_USER}@${VM_HOST}:${AZURE_APP_DIR}"

      - name: "Preflight: Install Docker on VM"
        if: steps.precheck.outputs.ready == 'true' && env.AUTO_INSTALL_DOCKER == 'true'
        env:
          VM_HOST: ${{ secrets.AZURE_VM_HOST }}
          VM_USER: ${{ secrets.AZURE_VM_USER }}
        run: |
          ssh -o StrictHostKeyChecking=no "${VM_USER}@${VM_HOST}" <<'EOFSSH'
            set -euo pipefail
            echo "Auto-installing Docker..."
            sudo apt-get update -qq
            sudo apt-get install -y docker.io docker-compose-plugin
            sudo usermod -aG docker "$USER"
            echo "Docker installed successfully."
            echo "WARNING: Group change applied. Log out of the VM and back in, then re-run this workflow."
          EOFSSH

      - name: "Preflight: Verify Docker on VM"
        if: steps.precheck.outputs.ready == 'true'
        env:
          VM_HOST: ${{ secrets.AZURE_VM_HOST }}
          VM_USER: ${{ secrets.AZURE_VM_USER }}
        run: |
          ssh -o StrictHostKeyChecking=no "${VM_USER}@${VM_HOST}" <<'EOFSSH'
            set -euo pipefail
            # Ensure deploy directory exists (safe on first deployment)
            sudo mkdir -p /opt/graphwise
            sudo chown "$USER":"$USER" /opt/graphwise
            # Verify docker
            if ! command -v docker &>/dev/null; then
              echo "ERROR: docker not found on VM."
              echo "To fix, SSH into the VM and run:"
              echo "  sudo apt update && sudo apt install -y docker.io docker-compose-plugin"
              echo "  sudo usermod -aG docker \$USER"
              echo "  # Log out and back in, then re-run this workflow."
              echo "Or set AUTO_INSTALL_DOCKER=true in the workflow env to install automatically."
              exit 1
            fi
            if ! docker compose version &>/dev/null; then
              echo "ERROR: 'docker compose' plugin not found on VM."
              echo "To fix: sudo apt install -y docker-compose-plugin"
              exit 1
            fi
            docker --version
            docker compose version
            echo "Docker preflight passed."
          EOFSSH

      - name: Deploy containers
        if: steps.precheck.outputs.ready == 'true'
        env:
          VM_HOST: ${{ secrets.AZURE_VM_HOST }}
          VM_USER: ${{ secrets.AZURE_VM_USER }}
        run: |
          ssh -o StrictHostKeyChecking=no "${VM_USER}@${VM_HOST}" <<'EOFSSH'
            set -euo pipefail
            cd /opt/graphwise
            docker compose --env-file .env -f infra/docker-compose.yml pull || true
            docker compose --env-file .env -f infra/docker-compose.yml up -d --build --remove-orphans
            docker compose --env-file .env -f infra/docker-compose.yml ps
          EOFSSH

      - name: Deploy skipped
        if: steps.precheck.outputs.ready != 'true'
        run: echo "Skipping Azure deployment because required secrets are missing."
